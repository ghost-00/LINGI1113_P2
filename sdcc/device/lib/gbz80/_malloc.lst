                              1 ;--------------------------------------------------------
                              2 ; File Created by SDCC : free open source ANSI-C Compiler
                              3 ; Version 2.9.4 #5595 (Oct 23 2013) (Mac OS X ppc)
                              4 ; This file was generated Wed Oct 23 12:26:12 2013
                              5 ;--------------------------------------------------------
                              6 	.module _malloc
                              7 	.optsdcc -mgbz80
                              8 	
                              9 ;--------------------------------------------------------
                             10 ; Public variables in this module
                             11 ;--------------------------------------------------------
                             12 	.globl __sdcc_heap_init
                             13 	.globl _malloc
                             14 ;--------------------------------------------------------
                             15 ;  ram data
                             16 ;--------------------------------------------------------
                             17 	.area _DATA
                             18 ;--------------------------------------------------------
                             19 ; overlayable items in  ram 
                             20 ;--------------------------------------------------------
                             21 	.area _OVERLAY
                             22 ;--------------------------------------------------------
                             23 ; external initialized ram data
                             24 ;--------------------------------------------------------
                             25 ;--------------------------------------------------------
                             26 ; global & static initialisations
                             27 ;--------------------------------------------------------
                             28 	.area _HOME
                             29 	.area _GSINIT
                             30 	.area _GSFINAL
                             31 	.area _GSINIT
                             32 ;--------------------------------------------------------
                             33 ; Home
                             34 ;--------------------------------------------------------
                             35 	.area _HOME
                             36 	.area _HOME
                             37 ;--------------------------------------------------------
                             38 ; code
                             39 ;--------------------------------------------------------
                             40 	.area _CODE
                             41 ;../_malloc.c:51: _sdcc_heap_init(void)
                             42 ;	---------------------------------
                             43 ; Function _sdcc_heap_init
                             44 ; ---------------------------------
   0000                      45 __sdcc_heap_init_start::
   0000                      46 __sdcc_heap_init:
                             47 	
                             48 ;../_malloc.c:53: MEMHEADER *pbase = &_sdcc_heap_start;
                             49 ;../_malloc.c:54: unsigned int size = &_sdcc_heap_end - (char *)pbase;
   0000 3Er00                50 	ld	a,#<(__sdcc_heap_end)
   0002 D6r00                51 	sub	a,#<(__sdcc_heap_start)
   0004 4F                   52 	ld	c,a
   0005 3Es00                53 	ld	a,#>(__sdcc_heap_end)
   0007 DEs00                54 	sbc	a,#>(__sdcc_heap_start)
   0009 47                   55 	ld	b,a
                             56 ;../_malloc.c:56: pbase->next = (MEMHEADER *)((char *)pbase + size - HEADER_SIZE);
   000A 21r00s00             57 	ld	hl,#__sdcc_heap_start
   000D 09                   58 	add	hl,bc
   000E 4D                   59 	ld	c,l
   000F 44                   60 	ld	b,h
   0010 79                   61 	ld	a,c
   0011 C6 FA                62 	add	a,#0xFA
   0013 4F                   63 	ld	c,a
   0014 78                   64 	ld	a,b
   0015 CE FF                65 	adc	a,#0xFF
   0017 47                   66 	ld	b,a
   0018 11r00s00             67 	ld	de,#__sdcc_heap_start
   001B 79                   68 	ld	a,c
   001C 12                   69 	ld	(de),a
   001D 13                   70 	inc	de
   001E 78                   71 	ld	a,b
   001F 12                   72 	ld	(de),a
                             73 ;../_malloc.c:57: pbase->next->next = NULL; //And mark it as last
   0020 59                   74 	ld	e,c
   0021 50                   75 	ld	d,b
   0022 3E 00                76 	ld	a,#0x00
   0024 12                   77 	ld	(de),a
   0025 13                   78 	inc	de
   0026 3E 00                79 	ld	a,#0x00
   0028 12                   80 	ld	(de),a
                             81 ;../_malloc.c:58: pbase->prev       = NULL; //and mark first as first
   0029 11r02s00             82 	ld	de,#0x0002 + __sdcc_heap_start
   002C 3E 00                83 	ld	a,#0x00
   002E 12                   84 	ld	(de),a
   002F 13                   85 	inc	de
   0030 3E 00                86 	ld	a,#0x00
   0032 12                   87 	ld	(de),a
                             88 ;../_malloc.c:59: pbase->len        = 0;    //Empty and ready.
   0033 11r04s00             89 	ld	de,#0x0004 + __sdcc_heap_start
   0036 3E 00                90 	ld	a,#0x00
   0038 12                   91 	ld	(de),a
   0039 13                   92 	inc	de
   003A 3E 00                93 	ld	a,#0x00
   003C 12                   94 	ld	(de),a
   003D                      95 00101$:
                             96 	
   003D C9                   97 	ret
   003E                      98 __sdcc_heap_init_end::
                             99 ;../_malloc.c:63: malloc (unsigned int size)
                            100 ;	---------------------------------
                            101 ; Function malloc
                            102 ; ---------------------------------
   003E                     103 _malloc_start::
   003E                     104 _malloc:
   003E E8 F6               105 	lda	sp,-10(sp)
                            106 ;../_malloc.c:69: if (size>(0xFFFF-HEADER_SIZE))
   0040 3E F9               107 	ld	a,#0xF9
   0042 F8 0C               108 	lda	hl,12(sp)
   0044 96                  109 	sub	a,(hl)
   0045 3E FF               110 	ld	a,#0xFF
   0047 23                  111 	inc	hl
   0048 9E                  112 	sbc	a,(hl)
   0049 D2r52s00            113 	jp	NC,00102$
                            114 ;../_malloc.c:71: return NULL; //To prevent overflow in next line
   004C 11 00 00            115 	ld	de,#0x0000
   004F C3rB0s01            116 	jp	00117$
   0052                     117 00102$:
                            118 ;../_malloc.c:74: size += HEADER_SIZE; //We need a memory for header too
   0052 F8 0D               119 	lda	hl,13(sp)
   0054 2B                  120 	dec	hl
   0055 5E                  121 	ld	e,(hl)
   0056 23                  122 	inc	hl
   0057 56                  123 	ld	d,(hl)
   0058 21 06 00            124 	ld	hl,#0x0006
   005B 19                  125 	add	hl,de
   005C 7D                  126 	ld	a,l
   005D 54                  127 	ld	d,h
   005E F8 0C               128 	lda	hl,12(sp)
   0060 22                  129 	ld	(hl+),a
   0061 72                  130 	ld	(hl),d
                            131 ;../_malloc.c:75: current_header = &_sdcc_heap_start;
   0062 F8 08               132 	lda	hl,8(sp)
   0064 36r00               133 	ld	(hl),#<(__sdcc_heap_start)
   0066 23                  134 	inc	hl
   0067 36s00               135 	ld	(hl),#>(__sdcc_heap_start)
                            136 ;../_malloc.c:124: }
   0069 F3                  137 	di
                            138 ;../_malloc.c:79: while (1)
   006A                     139 00108$:
                            140 ;../_malloc.c:88: if ((((unsigned int)current_header->next) -
   006A F8 09               141 	lda	hl,9(sp)
   006C 2B                  142 	dec	hl
   006D 5E                  143 	ld	e,(hl)
   006E 23                  144 	inc	hl
   006F 56                  145 	ld	d,(hl)
   0070 1A                  146 	ld	a,(de)
   0071 F8 02               147 	lda	hl,2(sp)
   0073 22                  148 	ld	(hl+),a
   0074 13                  149 	inc	de
   0075 1A                  150 	ld	a,(de)
   0076 32                  151 	ld	(hl-),a
   0077 7E                  152 	ld	a,(hl)
   0078 2B                  153 	dec	hl
   0079 2B                  154 	dec	hl
   007A 77                  155 	ld	(hl),a
   007B F8 03               156 	lda	hl,3(sp)
   007D 7E                  157 	ld	a,(hl)
   007E 2B                  158 	dec	hl
   007F 2B                  159 	dec	hl
   0080 77                  160 	ld	(hl),a
                            161 ;../_malloc.c:89: ((unsigned int)current_header) -
   0081 F8 08               162 	lda	hl,8(sp)
   0083 4E                  163 	ld	c,(hl)
   0084 23                  164 	inc	hl
   0085 46                  165 	ld	b,(hl)
   0086 F8 01               166 	lda	hl,1(sp)
   0088 2B                  167 	dec	hl
   0089 5E                  168 	ld	e,(hl)
   008A 23                  169 	inc	hl
   008B 56                  170 	ld	d,(hl)
   008C 7B                  171 	ld	a,e
   008D 91                  172 	sub	a,c
   008E 5F                  173 	ld	e,a
   008F 7A                  174 	ld	a,d
   0090 98                  175 	sbc	a,b
   0091 32                  176 	ld	(hl-),a
   0092 73                  177 	ld	(hl),e
                            178 ;../_malloc.c:90: current_header->len) >= size)
   0093 F8 09               179 	lda	hl,9(sp)
   0095 2B                  180 	dec	hl
   0096 5E                  181 	ld	e,(hl)
   0097 23                  182 	inc	hl
   0098 56                  183 	ld	d,(hl)
   0099 21 04 00            184 	ld	hl,#0x0004
   009C 19                  185 	add	hl,de
   009D 4D                  186 	ld	c,l
   009E 44                  187 	ld	b,h
   009F 59                  188 	ld	e,c
   00A0 50                  189 	ld	d,b
   00A1 1A                  190 	ld	a,(de)
   00A2 4F                  191 	ld	c,a
   00A3 13                  192 	inc	de
   00A4 1A                  193 	ld	a,(de)
   00A5 47                  194 	ld	b,a
   00A6 F8 01               195 	lda	hl,1(sp)
   00A8 2B                  196 	dec	hl
   00A9 5E                  197 	ld	e,(hl)
   00AA 23                  198 	inc	hl
   00AB 56                  199 	ld	d,(hl)
   00AC 7B                  200 	ld	a,e
   00AD 91                  201 	sub	a,c
   00AE 5F                  202 	ld	e,a
   00AF 7A                  203 	ld	a,d
   00B0 98                  204 	sbc	a,b
   00B1 47                  205 	ld	b,a
   00B2 4B                  206 	ld	c,e
   00B3 79                  207 	ld	a,c
   00B4 F8 0C               208 	lda	hl,12(sp)
   00B6 96                  209 	sub	a,(hl)
   00B7 78                  210 	ld	a,b
   00B8 23                  211 	inc	hl
   00B9 9E                  212 	sbc	a,(hl)
   00BA DArD0s00            213 	jp	C,00104$
                            214 ;../_malloc.c:92: ret = &current_header->mem;
   00BD F8 09               215 	lda	hl,9(sp)
   00BF 2B                  216 	dec	hl
   00C0 5E                  217 	ld	e,(hl)
   00C1 23                  218 	inc	hl
   00C2 56                  219 	ld	d,(hl)
   00C3 21 06 00            220 	ld	hl,#0x0006
   00C6 19                  221 	add	hl,de
   00C7 7D                  222 	ld	a,l
   00C8 54                  223 	ld	d,h
   00C9 F8 04               224 	lda	hl,4(sp)
   00CB 22                  225 	ld	(hl+),a
   00CC 72                  226 	ld	(hl),d
                            227 ;../_malloc.c:93: break;
   00CD C3rEFs00            228 	jp	00109$
   00D0                     229 00104$:
                            230 ;../_malloc.c:95: current_header = current_header->next;    //else try next
   00D0 F8 03               231 	lda	hl,3(sp)
   00D2 2B                  232 	dec	hl
   00D3 4E                  233 	ld	c,(hl)
   00D4 23                  234 	inc	hl
   00D5 46                  235 	ld	b,(hl)
   00D6 F8 08               236 	lda	hl,8(sp)
   00D8 71                  237 	ld	(hl),c
   00D9 23                  238 	inc	hl
   00DA 70                  239 	ld	(hl),b
                            240 ;../_malloc.c:96: if (!current_header->next)
   00DB 2B                  241 	dec	hl
   00DC 5E                  242 	ld	e,(hl)
   00DD 23                  243 	inc	hl
   00DE 56                  244 	ld	d,(hl)
   00DF 1A                  245 	ld	a,(de)
   00E0 4F                  246 	ld	c,a
   00E1 13                  247 	inc	de
   00E2 1A                  248 	ld	a,(de)
   00E3 47                  249 	ld	b,a
   00E4 B1                  250 	or	a,c
   00E5 C2r6As00            251 	jp	NZ,00108$
                            252 ;../_malloc.c:98: ret = NULL;
   00E8 F8 04               253 	lda	hl,4(sp)
   00EA 36 00               254 	ld	(hl),#0x00
   00EC 23                  255 	inc	hl
   00ED 36 00               256 	ld	(hl),#0x00
                            257 ;../_malloc.c:99: break;
   00EF                     258 00109$:
                            259 ;../_malloc.c:103: if (ret)
   00EF F8 04               260 	lda	hl,4(sp)
   00F1 2A                  261 	ld	a,(hl+)
   00F2 B6                  262 	or	a,(hl)
   00F3 CArA9s01            263 	jp	Z,00116$
                            264 ;../_malloc.c:105: if (!current_header->len)
   00F6 F8 09               265 	lda	hl,9(sp)
   00F8 2B                  266 	dec	hl
   00F9 5E                  267 	ld	e,(hl)
   00FA 23                  268 	inc	hl
   00FB 56                  269 	ld	d,(hl)
   00FC 21 04 00            270 	ld	hl,#0x0004
   00FF 19                  271 	add	hl,de
   0100 4D                  272 	ld	c,l
   0101 44                  273 	ld	b,h
   0102 59                  274 	ld	e,c
   0103 50                  275 	ld	d,b
   0104 1A                  276 	ld	a,(de)
   0105 F8 00               277 	lda	hl,0(sp)
   0107 22                  278 	ld	(hl+),a
   0108 13                  279 	inc	de
   0109 1A                  280 	ld	a,(de)
   010A 32                  281 	ld	(hl-),a
   010B 2A                  282 	ld	a,(hl+)
   010C B6                  283 	or	a,(hl)
   010D C2r1Ds01            284 	jp	NZ,00113$
                            285 ;../_malloc.c:107: current_header->len = size; //for first allocation
   0110 59                  286 	ld	e,c
   0111 50                  287 	ld	d,b
   0112 F8 0C               288 	lda	hl,12(sp)
   0114 7E                  289 	ld	a,(hl)
   0115 12                  290 	ld	(de),a
   0116 13                  291 	inc	de
   0117 23                  292 	inc	hl
   0118 7E                  293 	ld	a,(hl)
   0119 12                  294 	ld	(de),a
   011A C3rA9s01            295 	jp	00116$
   011D                     296 00113$:
                            297 ;../_malloc.c:112: new_header = (MEMHEADER * )((char *)current_header + current_header->len);
   011D F8 09               298 	lda	hl,9(sp)
   011F 2B                  299 	dec	hl
   0120 5E                  300 	ld	e,(hl)
   0121 23                  301 	inc	hl
   0122 56                  302 	ld	d,(hl)
   0123 F8 00               303 	lda	hl,0(sp)
   0125 2A                  304 	ld	a,(hl+)
   0126 66                  305 	ld	h,(hl)
   0127 6F                  306 	ld	l,a
   0128 19                  307 	add	hl,de
   0129 4D                  308 	ld	c,l
   012A 44                  309 	ld	b,h
   012B F8 06               310 	lda	hl,6(sp)
   012D 71                  311 	ld	(hl),c
   012E 23                  312 	inc	hl
   012F 70                  313 	ld	(hl),b
                            314 ;../_malloc.c:113: new_header->next = current_header->next; //and plug it into the chain
   0130 23                  315 	inc	hl
   0131 23                  316 	inc	hl
   0132 2B                  317 	dec	hl
   0133 5E                  318 	ld	e,(hl)
   0134 23                  319 	inc	hl
   0135 56                  320 	ld	d,(hl)
   0136 1A                  321 	ld	a,(de)
   0137 F8 00               322 	lda	hl,0(sp)
   0139 22                  323 	ld	(hl+),a
   013A 13                  324 	inc	de
   013B 1A                  325 	ld	a,(de)
   013C 77                  326 	ld	(hl),a
   013D F8 07               327 	lda	hl,7(sp)
   013F 2B                  328 	dec	hl
   0140 5E                  329 	ld	e,(hl)
   0141 23                  330 	inc	hl
   0142 56                  331 	ld	d,(hl)
   0143 F8 00               332 	lda	hl,0(sp)
   0145 7E                  333 	ld	a,(hl)
   0146 12                  334 	ld	(de),a
   0147 13                  335 	inc	de
   0148 23                  336 	inc	hl
   0149 7E                  337 	ld	a,(hl)
   014A 12                  338 	ld	(de),a
                            339 ;../_malloc.c:114: new_header->prev = current_header;
   014B F8 06               340 	lda	hl,6(sp)
   014D 4E                  341 	ld	c,(hl)
   014E 23                  342 	inc	hl
   014F 46                  343 	ld	b,(hl)
   0150 03                  344 	inc	bc
   0151 03                  345 	inc	bc
   0152 59                  346 	ld	e,c
   0153 50                  347 	ld	d,b
   0154 23                  348 	inc	hl
   0155 7E                  349 	ld	a,(hl)
   0156 12                  350 	ld	(de),a
   0157 13                  351 	inc	de
   0158 23                  352 	inc	hl
   0159 7E                  353 	ld	a,(hl)
   015A 12                  354 	ld	(de),a
                            355 ;../_malloc.c:115: current_header->next  = new_header;
   015B 2B                  356 	dec	hl
   015C 5E                  357 	ld	e,(hl)
   015D 23                  358 	inc	hl
   015E 56                  359 	ld	d,(hl)
   015F F8 06               360 	lda	hl,6(sp)
   0161 7E                  361 	ld	a,(hl)
   0162 12                  362 	ld	(de),a
   0163 13                  363 	inc	de
   0164 23                  364 	inc	hl
   0165 7E                  365 	ld	a,(hl)
   0166 12                  366 	ld	(de),a
                            367 ;../_malloc.c:116: if (new_header->next)
   0167 2B                  368 	dec	hl
   0168 5E                  369 	ld	e,(hl)
   0169 23                  370 	inc	hl
   016A 56                  371 	ld	d,(hl)
   016B 1A                  372 	ld	a,(de)
   016C 4F                  373 	ld	c,a
   016D 13                  374 	inc	de
   016E 1A                  375 	ld	a,(de)
   016F 47                  376 	ld	b,a
   0170 F8 00               377 	lda	hl,0(sp)
   0172 2A                  378 	ld	a,(hl+)
   0173 B6                  379 	or	a,(hl)
   0174 CAr83s01            380 	jp	Z,00111$
                            381 ;../_malloc.c:118: new_header->next->prev = new_header;
   0177 03                  382 	inc	bc
   0178 03                  383 	inc	bc
   0179 59                  384 	ld	e,c
   017A 50                  385 	ld	d,b
   017B F8 06               386 	lda	hl,6(sp)
   017D 7E                  387 	ld	a,(hl)
   017E 12                  388 	ld	(de),a
   017F 13                  389 	inc	de
   0180 23                  390 	inc	hl
   0181 7E                  391 	ld	a,(hl)
   0182 12                  392 	ld	(de),a
   0183                     393 00111$:
                            394 ;../_malloc.c:120: new_header->len  = size; //mark as used
   0183 F8 07               395 	lda	hl,7(sp)
   0185 2B                  396 	dec	hl
   0186 5E                  397 	ld	e,(hl)
   0187 23                  398 	inc	hl
   0188 56                  399 	ld	d,(hl)
   0189 21 04 00            400 	ld	hl,#0x0004
   018C 19                  401 	add	hl,de
   018D 4D                  402 	ld	c,l
   018E 44                  403 	ld	b,h
   018F 59                  404 	ld	e,c
   0190 50                  405 	ld	d,b
   0191 F8 0C               406 	lda	hl,12(sp)
   0193 7E                  407 	ld	a,(hl)
   0194 12                  408 	ld	(de),a
   0195 13                  409 	inc	de
   0196 23                  410 	inc	hl
   0197 7E                  411 	ld	a,(hl)
   0198 12                  412 	ld	(de),a
                            413 ;../_malloc.c:121: ret = &new_header->mem;
   0199 F8 07               414 	lda	hl,7(sp)
   019B 2B                  415 	dec	hl
   019C 5E                  416 	ld	e,(hl)
   019D 23                  417 	inc	hl
   019E 56                  418 	ld	d,(hl)
   019F 21 06 00            419 	ld	hl,#0x0006
   01A2 19                  420 	add	hl,de
   01A3 7D                  421 	ld	a,l
   01A4 54                  422 	ld	d,h
   01A5 F8 04               423 	lda	hl,4(sp)
   01A7 22                  424 	ld	(hl+),a
   01A8 72                  425 	ld	(hl),d
   01A9                     426 00116$:
   01A9 FB                  427 	ei
                            428 ;../_malloc.c:125: return ret;
   01AA F8 05               429 	lda	hl,5(sp)
   01AC 2B                  430 	dec	hl
   01AD 5E                  431 	ld	e,(hl)
   01AE 23                  432 	inc	hl
   01AF 56                  433 	ld	d,(hl)
   01B0                     434 00117$:
   01B0 E8 0A               435 	lda	sp,10(sp)
   01B2 C9                  436 	ret
   01B3                     437 _malloc_end::
                            438 	.area _CODE
                            439 	.area _CABS
