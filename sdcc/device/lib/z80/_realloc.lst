                              1 ;--------------------------------------------------------
                              2 ; File Created by SDCC : free open source ANSI-C Compiler
                              3 ; Version 2.9.4 #5595 (Oct 23 2013) (Mac OS X ppc)
                              4 ; This file was generated Wed Oct 23 12:26:09 2013
                              5 ;--------------------------------------------------------
                              6 	.module _realloc
                              7 	.optsdcc -mz80
                              8 	
                              9 ;--------------------------------------------------------
                             10 ; Public variables in this module
                             11 ;--------------------------------------------------------
                             12 	.globl _realloc
                             13 ;--------------------------------------------------------
                             14 ; special function registers
                             15 ;--------------------------------------------------------
                             16 ;--------------------------------------------------------
                             17 ;  ram data
                             18 ;--------------------------------------------------------
                             19 	.area _DATA
                             20 ;--------------------------------------------------------
                             21 ; overlayable items in  ram 
                             22 ;--------------------------------------------------------
                             23 	.area _OVERLAY
                             24 ;--------------------------------------------------------
                             25 ; external initialized ram data
                             26 ;--------------------------------------------------------
                             27 ;--------------------------------------------------------
                             28 ; global & static initialisations
                             29 ;--------------------------------------------------------
                             30 	.area _HOME
                             31 	.area _GSINIT
                             32 	.area _GSFINAL
                             33 	.area _GSINIT
                             34 ;--------------------------------------------------------
                             35 ; Home
                             36 ;--------------------------------------------------------
                             37 	.area _HOME
                             38 	.area _HOME
                             39 ;--------------------------------------------------------
                             40 ; code
                             41 ;--------------------------------------------------------
                             42 	.area _CODE
                             43 ;../_realloc.c:76: void __xdata * realloc (void * p, size_t size)
                             44 ;	---------------------------------
                             45 ; Function realloc
                             46 ; ---------------------------------
   0000                      47 _realloc_start::
   0000                      48 _realloc:
   0000 DD E5                49 	push	ix
   0002 DD 21 00 00          50 	ld	ix,#0
   0006 DD 39                51 	add	ix,sp
   0008 21 F8 FF             52 	ld	hl,#-8
   000B 39                   53 	add	hl,sp
   000C F9                   54 	ld	sp,hl
                             55 ;../_realloc.c:134: }
   000D ED 57                56 	ld	a,i
   000F F3                   57 	di
   0010 F5                   58 	push	af
                             59 ;../_realloc.c:84: pthis = _sdcc_find_memheader(p);
   0011 DD 6E 04             60 	ld	l,4 (ix)
   0014 DD 66 05             61 	ld	h,5 (ix)
   0017 E5                   62 	push	hl
   0018 CDr00s00             63 	call	__sdcc_find_memheader
   001B F1                   64 	pop	af
   001C 5D                   65 	ld	e,l
   001D 54                   66 	ld	d,h
                             67 ;../_realloc.c:85: if (pthis)
   001E 7B                   68 	ld	a,e
   001F B2                   69 	or	a,d
   0020 CArA8s01             70 	jp	Z,00114$
                             71 ;../_realloc.c:87: if (size > (0xFFFF-HEADER_SIZE))
   0023 3E F9                72 	ld	a,#0xF9
   0025 DD 96 06             73 	sub	a,6 (ix)
   0028 3E FF                74 	ld	a,#0xFF
   002A DD 9E 07             75 	sbc	a,7 (ix)
   002D 30 0B                76 	jr	NC,00111$
                             77 ;../_realloc.c:89: ret = (void __xdata *) NULL; //To prevent overflow in next line
   002F DD 36 FC 00          78 	ld	-4 (ix),#0x00
   0033 DD 36 FD 00          79 	ld	-3 (ix),#0x00
   0037 C3rB9s01             80 	jp	00115$
   003A                      81 00111$:
                             82 ;../_realloc.c:93: size += HEADER_SIZE; //We need a memory for header too
   003A DD 7E 06             83 	ld	a,6 (ix)
   003D C6 06                84 	add	a,#0x06
   003F DD 77 06             85 	ld	6 (ix),a
   0042 DD 7E 07             86 	ld	a,7 (ix)
   0045 CE 00                87 	adc	a,#0x00
   0047 DD 77 07             88 	ld	7 (ix),a
                             89 ;../_realloc.c:95: if ((((unsigned int)pthis->next) - ((unsigned int)pthis)) >= size)
   004A 6B                   90 	ld	l,e
   004B 62                   91 	ld	h,d
   004C 7E                   92 	ld	a,(hl)
   004D DD 77 FA             93 	ld	-6 (ix),a
   0050 23                   94 	inc	hl
   0051 7E                   95 	ld	a,(hl)
   0052 DD 77 FB             96 	ld	-5 (ix),a
   0055 DD 6E FA             97 	ld	l,-6 (ix)
   0058 DD 66 FB             98 	ld	h,-5 (ix)
   005B 4B                   99 	ld	c,e
   005C 42                  100 	ld	b,d
   005D 7D                  101 	ld	a,l
   005E 91                  102 	sub	a,c
   005F 6F                  103 	ld	l,a
   0060 7C                  104 	ld	a,h
   0061 98                  105 	sbc	a,b
   0062 67                  106 	ld	h,a
   0063 7D                  107 	ld	a,l
   0064 DD 96 06            108 	sub	a,6 (ix)
   0067 7C                  109 	ld	a,h
   0068 DD 9E 07            110 	sbc	a,7 (ix)
   006B 38 1E               111 	jr	C,00108$
                            112 ;../_realloc.c:97: pthis->len = size;
   006D 21 04 00            113 	ld	hl,#0x0004
   0070 19                  114 	add	hl,de
   0071 4D                  115 	ld	c,l
   0072 44                  116 	ld	b,h
   0073 DD 7E 06            117 	ld	a,6 (ix)
   0076 77                  118 	ld	(hl),a
   0077 23                  119 	inc	hl
   0078 DD 7E 07            120 	ld	a,7 (ix)
   007B 77                  121 	ld	(hl),a
                            122 ;../_realloc.c:98: ret = p;
   007C DD 7E 04            123 	ld	a,4 (ix)
   007F DD 77 FC            124 	ld	-4 (ix),a
   0082 DD 7E 05            125 	ld	a,5 (ix)
   0085 DD 77 FD            126 	ld	-3 (ix),a
   0088 C3rB9s01            127 	jp	00115$
   008B                     128 00108$:
                            129 ;../_realloc.c:102: if ((_sdcc_prev_memheader) &&
   008B FD 21r00s00         130 	ld	iy,#__sdcc_prev_memheader
   008F FD 7E 00            131 	ld	a,0 (iy)
   0092 FD B6 01            132 	or	a,1 (iy)
   0095 CAr59s01            133 	jp	Z,00104$
                            134 ;../_realloc.c:103: ((((unsigned int)pthis->next) -
   0098 DD 6E FA            135 	ld	l,-6 (ix)
   009B DD 66 FB            136 	ld	h,-5 (ix)
   009E DD 75 F8            137 	ld	-8 (ix),l
   00A1 DD 74 F9            138 	ld	-7 (ix),h
                            139 ;../_realloc.c:104: ((unsigned int)_sdcc_prev_memheader) -
   00A4 FD 4E 00            140 	ld	c,0 (iy)
   00A7 FD 46 01            141 	ld	b,1 (iy)
   00AA DD 7E F8            142 	ld	a,-8 (ix)
   00AD 91                  143 	sub	a,c
   00AE DD 77 F8            144 	ld	-8 (ix),a
   00B1 DD 7E F9            145 	ld	a,-7 (ix)
   00B4 98                  146 	sbc	a,b
   00B5 DD 77 F9            147 	ld	-7 (ix),a
                            148 ;../_realloc.c:105: _sdcc_prev_memheader->len) >= size))
   00B8 2Ar00s00            149 	ld	hl,(__sdcc_prev_memheader)
   00BB 7D                  150 	ld	a,l
   00BC C6 04               151 	add	a,#0x04
   00BE 4F                  152 	ld	c,a
   00BF 6F                  153 	ld	l,a
   00C0 7C                  154 	ld	a,h
   00C1 CE 00               155 	adc	a,#0x00
   00C3 67                  156 	ld	h,a
   00C4 7E                  157 	ld	a,(hl)
   00C5 23                  158 	inc	hl
   00C6 66                  159 	ld	h,(hl)
   00C7 6F                  160 	ld	l,a
   00C8 DD 7E F8            161 	ld	a,-8 (ix)
   00CB 95                  162 	sub	a,l
   00CC 6F                  163 	ld	l,a
   00CD DD 7E F9            164 	ld	a,-7 (ix)
   00D0 9C                  165 	sbc	a,h
   00D1 67                  166 	ld	h,a
   00D2 7D                  167 	ld	a,l
   00D3 DD 96 06            168 	sub	a,6 (ix)
   00D6 7C                  169 	ld	a,h
   00D7 DD 9E 07            170 	sbc	a,7 (ix)
   00DA DAr59s01            171 	jp	C,00104$
                            172 ;../_realloc.c:107: pnew = (MEMHEADER __xdata * )((char __xdata *)_sdcc_prev_memheader + _sdcc_prev_memheader->len);
   00DD 2Ar00s00            173 	ld	hl,(__sdcc_prev_memheader)
   00E0 7D                  174 	ld	a,l
   00E1 C6 04               175 	add	a,#0x04
   00E3 6F                  176 	ld	l,a
   00E4 7C                  177 	ld	a,h
   00E5 CE 00               178 	adc	a,#0x00
   00E7 67                  179 	ld	h,a
   00E8 4E                  180 	ld	c,(hl)
   00E9 23                  181 	inc	hl
   00EA 46                  182 	ld	b,(hl)
   00EB FD 7E 00            183 	ld	a,0 (iy)
   00EE 81                  184 	add	a,c
   00EF 4F                  185 	ld	c,a
   00F0 FD 7E 01            186 	ld	a,1 (iy)
   00F3 88                  187 	adc	a,b
   00F4 47                  188 	ld	b,a
   00F5 DD 71 FE            189 	ld	-2 (ix),c
   00F8 DD 70 FF            190 	ld	-1 (ix),b
                            191 ;../_realloc.c:108: _sdcc_prev_memheader->next = pnew;
   00FB 2Ar00s00            192 	ld	hl,(__sdcc_prev_memheader)
   00FE DD 7E FE            193 	ld	a,-2 (ix)
   0101 77                  194 	ld	(hl),a
   0102 23                  195 	inc	hl
   0103 DD 7E FF            196 	ld	a,-1 (ix)
   0106 77                  197 	ld	(hl),a
                            198 ;../_realloc.c:111: pthis->next->prev = pnew;
   0107 DD 6E FA            199 	ld	l, -6 (ix)
   010A DD 66 FB            200 	ld	h, -5 (ix)
   010D 23                  201 	inc	hl
   010E 23                  202 	inc	hl
   010F DD 7E FE            203 	ld	a,-2 (ix)
   0112 77                  204 	ld	(hl),a
   0113 23                  205 	inc	hl
   0114 DD 7E FF            206 	ld	a,-1 (ix)
   0117 77                  207 	ld	(hl),a
                            208 ;../_realloc.c:114: memmove(pnew, pthis, pthis->len);
   0118 21 04 00            209 	ld	hl,#0x0004
   011B 19                  210 	add	hl,de
   011C 7E                  211 	ld	a,(hl)
   011D 23                  212 	inc	hl
   011E 66                  213 	ld	h,(hl)
   011F 6F                  214 	ld	l,a
   0120 E5                  215 	push	hl
   0121 D5                  216 	push	de
   0122 DD 6E FE            217 	ld	l,-2 (ix)
   0125 DD 66 FF            218 	ld	h,-1 (ix)
   0128 E5                  219 	push	hl
   0129 CDr00s00            220 	call	_memmove
   012C F1                  221 	pop	af
   012D F1                  222 	pop	af
   012E F1                  223 	pop	af
                            224 ;../_realloc.c:115: pnew->len = size;
   012F DD 7E FE            225 	ld	a,-2 (ix)
   0132 C6 04               226 	add	a,#0x04
   0134 4F                  227 	ld	c,a
   0135 DD 7E FF            228 	ld	a,-1 (ix)
   0138 CE 00               229 	adc	a,#0x00
   013A 47                  230 	ld	b,a
   013B 69                  231 	ld	l,c
   013C 67                  232 	ld	h,a
   013D DD 7E 06            233 	ld	a,6 (ix)
   0140 77                  234 	ld	(hl),a
   0141 23                  235 	inc	hl
   0142 DD 7E 07            236 	ld	a,7 (ix)
   0145 77                  237 	ld	(hl),a
                            238 ;../_realloc.c:116: ret = MEM(pnew);
   0146 DD 7E FE            239 	ld	a,-2 (ix)
   0149 C6 06               240 	add	a,#0x06
   014B DD 77 FC            241 	ld	-4 (ix),a
   014E DD 7E FF            242 	ld	a,-1 (ix)
   0151 CE 00               243 	adc	a,#0x00
   0153 DD 77 FD            244 	ld	-3 (ix),a
   0156 C3rB9s01            245 	jp	00115$
   0159                     246 00104$:
                            247 ;../_realloc.c:120: ret = malloc(size - HEADER_SIZE);
   0159 DD 7E 06            248 	ld	a,6 (ix)
   015C C6 FA               249 	add	a,#0xFA
   015E 6F                  250 	ld	l,a
   015F DD 7E 07            251 	ld	a,7 (ix)
   0162 CE FF               252 	adc	a,#0xFF
   0164 67                  253 	ld	h,a
   0165 D5                  254 	push	de
   0166 E5                  255 	push	hl
   0167 CDr00s00            256 	call	_malloc
   016A F1                  257 	pop	af
   016B D1                  258 	pop	de
   016C DD 75 FC            259 	ld	-4 (ix),l
   016F DD 74 FD            260 	ld	-3 (ix),h
                            261 ;../_realloc.c:121: if (ret)
   0172 DD 7E FC            262 	ld	a,-4 (ix)
   0175 DD B6 FD            263 	or	a,-3 (ix)
   0178 28 3F               264 	jr	Z,00115$
                            265 ;../_realloc.c:123: memcpy(ret, MEM(pthis), pthis->len - HEADER_SIZE);
   017A 21 06 00            266 	ld	hl,#0x0006
   017D 19                  267 	add	hl,de
   017E 4D                  268 	ld	c,l
   017F 44                  269 	ld	b,h
   0180 13                  270 	inc	de
   0181 EB                  271 	ex	de,hl
   0182 23                  272 	inc	hl
   0183 23                  273 	inc	hl
   0184 23                  274 	inc	hl
   0185 7E                  275 	ld	a,(hl)
   0186 23                  276 	inc	hl
   0187 66                  277 	ld	h,(hl)
   0188 C6 FA               278 	add	a,#0xFA
   018A 5F                  279 	ld	e,a
   018B 7C                  280 	ld	a,h
   018C CE FF               281 	adc	a,#0xFF
   018E 57                  282 	ld	d,a
   018F 69                  283 	ld	l,c
   0190 60                  284 	ld	h,b
   0191 4B                  285 	ld	c,e
   0192 42                  286 	ld	b,d
   0193 DD 5E FC            287 	ld	e,-4 (ix)
   0196 DD 56 FD            288 	ld	d,-3 (ix)
   0199 ED B0               289 	ldir
                            290 ;../_realloc.c:124: free(p);
   019B DD 6E 04            291 	ld	l,4 (ix)
   019E DD 66 05            292 	ld	h,5 (ix)
   01A1 E5                  293 	push	hl
   01A2 CDr00s00            294 	call	_free
   01A5 F1                  295 	pop	af
   01A6 18 11               296 	jr	00115$
   01A8                     297 00114$:
                            298 ;../_realloc.c:132: ret = malloc(size);
   01A8 DD 6E 06            299 	ld	l,6 (ix)
   01AB DD 66 07            300 	ld	h,7 (ix)
   01AE E5                  301 	push	hl
   01AF CDr00s00            302 	call	_malloc
   01B2 F1                  303 	pop	af
   01B3 DD 75 FC            304 	ld	-4 (ix),l
   01B6 DD 74 FD            305 	ld	-3 (ix),h
   01B9                     306 00115$:
   01B9 F1                  307 	pop	af
   01BA E2rBEs01            308 	jp	PO,00125$
   01BD FB                  309 	ei
   01BE                     310 00125$:
                            311 ;../_realloc.c:135: return ret;
   01BE DD 6E FC            312 	ld	l,-4 (ix)
   01C1 DD 66 FD            313 	ld	h,-3 (ix)
   01C4 DD F9               314 	ld	sp,ix
   01C6 DD E1               315 	pop	ix
   01C8 C9                  316 	ret
   01C9                     317 _realloc_end::
                            318 	.area _CODE
                            319 	.area _CABS
